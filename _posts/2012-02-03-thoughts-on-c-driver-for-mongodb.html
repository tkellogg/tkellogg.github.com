---
layout: post
title: "Thoughts on the C# driver for MongoDB"
date: 2012-02-03
comments: false
---

<div class='post'>
I recently started a new job with a software company in Boulder. Our project this year is rewriting the existing product (not a clean rewrite, more like rewrite &amp; evolve). One of the changes we're making is using <a href="http://www.mongodb.org/">MongoDB</a> instead of <a href="http://en.wikipedia.org/wiki/Transact-SQL">T-SQL</a>. Since we're going to be investing pretty heavily in Mongo we all attended the mongo conference in Boulder on Wednesday. The information was great and now I'm ready to dig into my first app. Today I played around with some test code and made some notes about features/shortcomings of the <a href="http://www.mongodb.org/display/DOCS/CSharp+Driver+Tutorial#CSharpDriverTutorial-Introduction">C# driver</a>.<br /><br />First of all, the so-called "driver" is much full featured than a typical SQL driver. It includes features to map documents directly to CLR objects (from here on I'll just say <i>document</i>&nbsp;if I mean Mongo BSON document and <i>object</i>&nbsp;for CLR object). There's plans to support Linq directly from the driver. So right off I'm impressed with the richness of the driver.&nbsp;However,&nbsp;I noticed some shortcomings.<br /><br />For instance, all properties in the document must be present (and of the right type) in the object. I perceived this as a shortcoming because this is unlike regular JSON serialization where missing properties are ignored. After thinking a little further, this is probably what most C# developers would want since the behavior caters toward strongly typed languages that prefer fail-fast behavior.&nbsp;If you know a particular document might have extraneous properties that aren't in the object, you can use the <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">BsonIgnoreExtraElements</span> attribute.<br /><br />Thinking about this behavior, refactor renaming properties could be less trivial. You would have to run a data migration script to rename the property (mongo does have <a href="http://www.mongodb.org/display/DOCS/Updating#Updating-%24rename">an operation</a> for renaming fields). It would be great if the driver had a <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[BsonAlias("OldValue")]</span> attribute to avoid migration scripts (maybe I'll make a pull request).<br /><br />Something I liked was that I could use <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">object</span> for the type of the <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">_id</span> property instead of <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">BsonObjectId</span>. This will keep the models less coupled to the Mongo driver API. Also, the driver already has a bi-directional alias for <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">_id</span> as <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Id</span>. I don't know any C# developers who wouldn't squirm at creating a public property named _<span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">id</span>.<br /><br />This brings me to my biggest issue with the C# mongo driver. All properties must be public. This breaks the encapsulation and SRP principles. For instance, most of the time I have no reason to expose my <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Id</span> (or <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">_id</span>) property as public. NHibernate solves this by hydrating protected fields. I would like this to be solved very soon (but there are some issues with this since there isn't any mappings).<br /><br />Last, it has poor support for C# 4.0 types. Tuple doesn't fail, but it's serialized as an empty object ({ }). There is also zero support AFAIK for dynamic.<br /><br />In conclusion, there's some room for improvement with Mongo's integration with .NET but overall I have to say I'm impressed. Supposedly Linq support is due out very soon, which will make it unstoppable (imo). Also, we haven't started using this in a full production environment yet, so there will most likely be more posts coming on this topic.</div>
