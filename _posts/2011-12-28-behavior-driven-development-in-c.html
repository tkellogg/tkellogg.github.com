---
layout: post
title: "Behavior Driven Development in C#"
date: 2011-12-28
comments: false
categories:
 - open source
 - BDD
 - unit testing
 - engineering
 - code
 - c#
---

<div class='post'>
I've been a fan of Test Driven Development since I worked in an XP shop. But every time the work starts getting bigger and more complex I always struggle to not get lost in the magnitudes of tests. I remember many early-on conversations with my <i>elders</i>&nbsp;about unit test naming conventions. The [method]_[input]_[output] convention starts to break down badly when your inputs become things like mocks, or if there ends up being more than 1 or 2 inputs; same with outputs.<br /><br />When <a href="http://twitter.com/#!/mjezzi">a coworker</a> introduced me to BDD earlier this year, it really clicked and flowed naturally. The idea of writing tests so they read like sentences out of a book or spec seems like the answer to all my questions. The ruby <a href="http://rspec.info/documentation/">rspec</a>&nbsp;is beautiful:<br /><br /><script src="https://gist.github.com/1528845.js?file=simple_rspec.rb"></script><br />The organization of the tests forces you to focus on the expectations of your test and highlight descriptive assertions. This is especially useful for complicated setups with lots of mocks, etc. I put as much of my setup code in one of those <span style="font-family: 'Courier New', Courier, monospace;">before :each</span> blocks, so that way the assertions are limited to simple inputs and one or two observations about the outputs.<br /><br />There's been a number of <a href="http://persistall.com/archive/2007/11/05/further-thoughts-on-bdd-in-c.aspx">people</a> in the .NET community that have attempted BDD but [imo] failed to grasp the simplicity. NBehave is a complete overhaul of unit testing that uses attributes like <i>x</i>Unit. As a result, NBehave doesn't really look at all like rspec - which really isn't a bad thing, necessarily. However, the thing I like about rspec is it's ability to describe things of arbitrary depth, which is handy when testing complex code:<br /><br /><script src="https://gist.github.com/1528845.js?file=complex_rspec.rb"></script><br />This spec is able to describe possible modes that the object under test can be in (complex inputs). This is made possible by rspec's arbitrary nesting depth. This is definitely a language feature that is much harder to implement in C#.<br /><br />My current approach to BDD in C# usually looks like<br /><br /><script src="https://gist.github.com/1528845.js?file=BDD.cs"></script><br />I think this is the simplest BDD layer I can slap on top of NUnit. And simple is important to me because (a) I do a lot of open source projects and I want to keep the barrier to entry for contributions low and (b) the people I work with tend to resist change. When people are resistant to change, it's hard to rationalize using something other than NUnit or introducing lots of nested lambdas.<br /><br />NUnit remains the most popular unit testing framework and has excellent support with a GUI runner, console runner, and IDE integration with R#, TestDriven.NET, and others. Given all that support, I would really rather not abandon NUnit if possible.<br /><br /><a href="http://fluentassertions.codeplex.com/">FluentAssertions</a> is a nice simple BDD layer on top of NUnit (or whatever you use). It doesn't change the structure of our spec above, but it does change the structure of our assertion to<br /><br /><script src="https://gist.github.com/1528845.js?file=FluentAssertion_BDD.cs"></script><br />This assertion is [imo] very clean and succinct. I like how it reads even clearer than NUnit's fluent syntax. Last weekend I was thinking about this and I decided to explore an idea to make a BDD extension to NUnit that is even clearer than FluentAssertions. The project, BehavioralNUnit for now, is hosted at&nbsp;<a href="https://github.com/tkellogg/BehavioralNUnit">github</a>. The earliest goal for the project was simply to use operator overloading to make the assertions even more like rspec. For instance, I want to be make the previous assertion:<br /><br /><script src="https://gist.github.com/1528845.js?file=BehavioralNUnit_simple.cs"></script><br />I was able to do this, but I realized that the C# compiler was insisting that this expression needed to be assigned to something, so I [haven't yet] added another concept somewhat analogous to "it" in rspec:<br /><br /><script src="https://gist.github.com/1528845.js?file=BehavioralNUnit_complex.cs"></script><br />This is most similar to <a href="http://nspec.org/">NSpec's approach</a> by using an indexer instead of a method. This appeals to me because I sometimes find matching parentheses to be a pain (I guess I just like ruby &amp; coffeescript). Then again, I don't like NSpec because it feels like it was written by one of those whining .NET developers that wishes dearly he could get a RoR job - it doesn't abide to .NET conventions at all.<br /><br />I still have a ton of ideas to hash out with Behavioral NUnit. I'm convinced that BDD in C# can be simpler and more beautiful than it currently is. If you have input or ideas, please <a href="https://github.com/tkellogg/BehavioralNUnit">fork the repository</a> &amp; try out your ideas (pull requests are welcome).<br /><div><br /></div></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Tim Kellogg</div>
<div class='content'>
Michael, thanks for the link to BDDify. I&#39;ve never seen that particular approach before. It&#39;s a different angle than what I&#39;m trying to accomplish with Behavioral NUnit. They&#39;re not mutually exclusive; in fact they&#39;d probably work well together.<br /><br />As far as the Moq Contrib container, I just started a new job this week and I&#39;m still trying to gauge their in IoC, and what container they&#39;ll want to use. I may end up contributing a third container to MoqContrib if it seems appropriate. I&#39;ll try to post some info about the direction I&#39;m moving in with that soon.</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Hi Tim<br /><br />Have you seen bddify? It&#39;s quite a new BDD framework for .Net and aims for that simplicity you&#39;re talking about.<br />http://www.mehdi-khalili.com/bddify-in-action/introduction<br /><br />I actually came to your site to see if anything was happening with your Moq Contrib AutoMocking container with Castle Windsor? That seemed pretty interesting...<br /><br />Thanks<br />Michael</div>
</div>
</div>
