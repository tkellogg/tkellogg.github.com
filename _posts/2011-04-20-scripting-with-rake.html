---
layout: post
title: "Scripting with rake"
date: 2011-04-20
comments: false
---

<div class='post'>
<a href="http://martinfowler.com/articles/rake.html">Rake</a> is a great twist on traditional <a href="http://www.gnu.org/software/make/">make</a>&nbsp;(honestly, I never really liked <a href="http://ant.apache.org/">Ant</a> or <a href="http://nant.sourceforge.net/">NAnt</a>). On the surface it looks more like make than Ant or Nant, but you can leverage the full syntax and standard library of <a href="http://www.ruby-lang.org/en/">Ruby</a>&nbsp;(and there's no <a href="http://www.gnu.org/s/hello/manual/make/Error-Messages.html">weird rules about tabs</a>). As a .NET developer, <a href="https://github.com/derickbailey/Albacore">albacore</a> augments rake nicely with tasks for MSBuild (building Visual Studio projects and solutions), NUnit, ASP.NET precompiler, modifying your <a href="https://github.com/derickbailey/Albacore/wiki/AssemblyInfoTask">AssemblyInfo.cs</a> (like for bumping the version number), and many more.<br /><br />Since rake is just ruby code, you can do just about anything, but most file manipulation routines are even easier to write in rake, because most everything is already imported and ready to use. Unlike make, Ant, and Nant, you don't have to start a separate project just to develop tools to use in a rakefile, just write a ruby function!<br /><br /><span class="Apple-style-span" style="font-size: large;">Building dependencies first</span><br />A lot of people who aren't already familiar with build languages make some common mistakes. Among them, not using dependencies correctly. For instance, given a website solution that references framework<br /><br /><pre class="brush: ruby">msbuild :framework do |msb|<br />&nbsp;&nbsp;msb.solution = 'framework/src/framework.sln'<br />end<br /><br />msbuild :website do |msb|<br />&nbsp;&nbsp;msb.solution = 'src/website.sln'<br />end<br /><br />task :default =&gt; [:framework, :website]<br /></pre><br />The default task is the task that's executed when you just type <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">rake</span>&nbsp;at the CLI. The reason this is terrible is that it's procedural and inflexible. Now, if I do <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">rake website</span> the build fails because framework hasn't been built yet. Instead, each task should specify what other tasks it <i>directly</i>&nbsp;relies on. This script should change to:<br /><br /><pre class="brush: ruby">msbuild :framework do |msb|<br />  msb.solution = 'framework/src/framework.sln'<br />end<br /><br />msbuild :website =&gt; :framework do |msb|<br />  msb.solution = 'src/website.sln'<br />end<br /><br />task :default =&gt; :website<br /></pre><br />This way both <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">rake</span>&nbsp;and <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">rake website</span> work the same. This leverages rakes dependency framework that is at the core of all build languages.<br /><br /><span class="Apple-style-span" style="font-size: large;">Using file tasks</span><br />The other point that people often forget is that build languages are oriented around files. <i>Make</i> tasks were oriented around questions like <i>"does this file need to be created?"</i>. This is where rakes <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">file</span> task comes in very handy. For instance, the above tasks can become<br /><br /><pre class="brush: ruby">$framework_dll = 'framework/src/framework/bin/Debug/framework.dll'<br /><br />file $framework_dll =&gt; :framework<br /><br />$website_dll = 'website/bin/Debug/website.dll'<br /><br />file $website_dll =&gt; :website<br /><br />msbuild :framework do |msb|<br />  msb.solution = 'framework/src/framework.sln'<br />end<br /><br />msbuild :website =&gt; $framework_dll do |msb|<br />  msb.solution = 'src/website.sln'<br />end<br /><br />task :default =&gt; $website_dll<br /></pre><br />This makes it so that framework and website are only built if they aren't built already and won't be attempted unless they're missing.<br /><br /><span class="Apple-style-span" style="font-size: large;">Arbitrary scripting</span><br />Rake is a great platform for hosting arbitrary scripts that you might write to automate your development process. I have scripts to bump the assembly version and subsequently commit to git, deploy to our test server, and I plan to make tasks to interact with redmine via it's REST API (something certainly not possible in NAnt). Basically, any little task that I might write a script for (which is quite a bit) can be imported into the rakefile and mounted as a task (yes, ruby is very modular).</div>
